<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="è—ä¹¦é˜ - åœ¨çº¿é˜…è¯»">
  <title>è—ä¹¦é˜</title>
  <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
  <!-- Docsify ä¸»é¢˜ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsify-themeable@0/dist/css/theme-simple.css">
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <style>
    :root {
      /* ä¸»é¢˜è‰² */
      --theme-color: #3F51B5;

      /* ä¾§è¾¹æ  */
      --sidebar-width: 280px;
      --sidebar-background: #f8f9fa;

      /* ä¸­æ–‡å­—ä½“ä¼˜åŒ– */
      --base-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans SC", "Microsoft YaHei", sans-serif;
      --content-max-width: 900px;

      /* ä»£ç å— */
      --code-font-family: "Fira Code", "Source Code Pro", Consolas, monospace;
    }

    /* ä¸­æ–‡æ’ç‰ˆä¼˜åŒ– */
    .markdown-section {
      line-height: 1.8;
      letter-spacing: 0.02em;
    }

    .markdown-section h1,
    .markdown-section h2,
    .markdown-section h3 {
      font-weight: 600;
    }

    /* å›¾ç‰‡å±…ä¸­ä¸”å“åº”å¼ */
    .markdown-section img {
      display: block;
      max-width: 100%;
      margin: 1em auto;
      border-radius: 4px;
    }

    /* å¼•ç”¨å—æ ·å¼ */
    .markdown-section blockquote {
      border-left: 4px solid var(--theme-color);
      background: #f5f5f5;
      padding: 1em;
      margin: 1em 0;
    }

    /* æœç´¢æ¡†ä¼˜åŒ– */
    .search input {
      font-size: 16px !important;
    }

  </style>
</head>
<body>
  <div id="app">æ­£åœ¨åŠ è½½...</div>

  <script>
    window.$docsify = {
      name: 'ğŸ“š è—ä¹¦é˜',
      repo: '', // å¯ä»¥å¡«å…¥ä½ çš„ GitHub ä»“åº“åœ°å€

      // åŠ è½½ä¾§è¾¹æ 
      loadSidebar: true,

      // å­ç›®å½•ä½¿ç”¨è‡ªå·±çš„ä¾§è¾¹æ 
      alias: {
        '/books/.*/.*/_sidebar.md': '/books/_sidebar.md',
        '/_sidebar.md': '/_sidebar.md'
      },

      // è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜
      subMaxLevel: 3,

      // é¦–é¡µ
      homepage: 'README.md',

      // æœç´¢é…ç½®
      search: {
        placeholder: 'æœç´¢...',
        noData: 'æ²¡æœ‰æ‰¾åˆ°ç»“æœ',
        paths: [
          '/',
          '/books/qi-ti-yuan-liu/'
        ],
        depth: 6,
        maxAge: 86400000,
        hideOtherSidebarContent: true,
        namespace: 'cangshuge-v2',
      },

      // å¤åˆ¶ä»£ç æ’ä»¶é…ç½®
      copyCode: {
        buttonText: 'å¤åˆ¶',
        successText: 'å·²å¤åˆ¶',
      },

      // åˆ†é¡µé…ç½®
      pagination: {
        previousText: 'ä¸Šä¸€ç« ',
        nextText: 'ä¸‹ä¸€ç« ',
        crossChapter: true,
      },

      // å­—æ•°ç»Ÿè®¡
      count: {
        countable: true,
        position: 'top',
        margin: '10px',
        float: 'right',
        fontsize: '0.9em',
        color: 'rgb(90,90,90)',
        language: 'chinese',
      },

      // 404 é¡µé¢
      notFoundPage: true,

      // è·¯ç”±æ¨¡å¼ - ä½¿ç”¨ hash æ¨¡å¼å…¼å®¹ GitHub Pages
      routerMode: 'hash',

      // ç›¸å¯¹è·¯å¾„
      relativePath: true,
    }
  </script>

  <!-- Docsify æ ¸å¿ƒ -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/docsify.min.js"></script>

  <!-- æœç´¢æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/search.min.js"></script>

  <!-- å›¾ç‰‡ç¼©æ”¾ -->
  <script src="https://cdn.jsdelivr.net/npm/docsify@4/lib/plugins/zoom-image.min.js"></script>

  <!-- å¤åˆ¶ä»£ç  -->
  <script src="https://cdn.jsdelivr.net/npm/docsify-copy-code@2"></script>

  <!-- åˆ†é¡µå¯¼èˆª -->
  <script src="https://cdn.jsdelivr.net/npm/docsify-pagination@2/dist/docsify-pagination.min.js"></script>

  <!-- å­—æ•°ç»Ÿè®¡ -->
  <script src="https://cdn.jsdelivr.net/npm/docsify-count@latest/dist/countable.min.js"></script>

  <!-- ä»£ç é«˜äº® - æ”¯æŒå¤šç§è¯­è¨€ -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-javascript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-typescript.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-yaml.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-markdown.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-java.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-go.min.js"></script>

  <!-- è—ä¹¦é˜è‡ªå®šä¹‰èŠå¤©æœºå™¨äºº -->
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Chatbot Styles -->
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       è—ä¹¦é˜ Chatbot - Scholar's Study Aesthetic
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root {
      --chat-primary: #3F51B5;
      --chat-primary-dark: #303F9F;
      --chat-primary-light: #5C6BC0;
      --chat-bg: #FAFBFC;
      --chat-surface: #FFFFFF;
      --chat-text: #2D3748;
      --chat-text-secondary: #718096;
      --chat-border: #E2E8F0;
      --chat-user-bubble: #3F51B5;
      --chat-ai-bubble: #F7F8FA;
      --chat-shadow: 0 8px 32px rgba(45, 55, 72, 0.12);
      --chat-shadow-lg: 0 16px 48px rgba(45, 55, 72, 0.16);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Floating Chat Button
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-chat-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-primary-dark) 100%);
      border: none;
      cursor: pointer;
      box-shadow: var(--chat-shadow), 0 0 0 0 rgba(63, 81, 181, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: csg-pulse 2s infinite;
    }

    @keyframes csg-pulse {
      0%, 100% { box-shadow: var(--chat-shadow), 0 0 0 0 rgba(63, 81, 181, 0.4); }
      50% { box-shadow: var(--chat-shadow), 0 0 0 8px rgba(63, 81, 181, 0); }
    }

    .csg-chat-btn:hover {
      transform: scale(1.08);
      box-shadow: var(--chat-shadow-lg);
      animation: none;
    }

    .csg-chat-btn:active {
      transform: scale(0.95);
    }

    .csg-chat-btn svg {
      width: 28px;
      height: 28px;
      fill: white;
      transition: transform 0.3s ease;
    }

    .csg-chat-btn:hover svg {
      transform: rotate(-8deg);
    }

    .csg-chat-btn.is-open svg {
      transform: rotate(180deg);
    }

    /* Unread badge */
    .csg-chat-btn::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background: #EF4444;
      border-radius: 50%;
      border: 2px solid white;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s ease;
    }

    .csg-chat-btn.has-unread::after {
      opacity: 1;
      transform: scale(1);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Chat Window Container
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-chat-window {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 400px;
      height: 580px;
      background: var(--chat-surface);
      border-radius: 20px;
      box-shadow: var(--chat-shadow-lg);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px) scale(0.95);
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .csg-chat-window.is-open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0) scale(1);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Chat Header
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-chat-header {
      background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-primary-dark) 100%);
      padding: 18px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      position: relative;
      overflow: hidden;
    }

    /* Subtle pattern overlay */
    .csg-chat-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.5;
    }

    .csg-chat-header-info {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .csg-chat-avatar {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .csg-chat-title {
      color: white;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .csg-chat-subtitle {
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      margin-top: 2px;
    }

    .csg-chat-actions {
      display: flex;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .csg-chat-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .csg-chat-action-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
    }

    .csg-chat-action-btn svg {
      width: 18px;
      height: 18px;
      fill: currentColor;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Messages Container
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--chat-bg);
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    /* Custom scrollbar */
    .csg-chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .csg-chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .csg-chat-messages::-webkit-scrollbar-thumb {
      background: var(--chat-border);
      border-radius: 3px;
    }

    .csg-chat-messages::-webkit-scrollbar-thumb:hover {
      background: var(--chat-text-secondary);
    }

    /* Welcome message */
    .csg-chat-welcome {
      text-align: center;
      padding: 32px 20px;
    }

    .csg-chat-welcome-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-primary-light) 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 8px 24px rgba(63, 81, 181, 0.25);
    }

    .csg-chat-welcome h3 {
      color: var(--chat-text);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .csg-chat-welcome p {
      color: var(--chat-text-secondary);
      font-size: 14px;
      line-height: 1.6;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Message Bubbles
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-message {
      display: flex;
      gap: 10px;
      max-width: 85%;
      animation: csg-message-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes csg-message-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .csg-message.is-user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .csg-message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .csg-message.is-ai .csg-message-avatar {
      background: var(--chat-primary);
      color: white;
    }

    .csg-message.is-user .csg-message-avatar {
      background: var(--chat-border);
    }

    .csg-message-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .csg-message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.6;
      word-wrap: break-word;
    }

    .csg-message.is-ai .csg-message-bubble {
      background: var(--chat-surface);
      color: var(--chat-text);
      border-bottom-left-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .csg-message.is-user .csg-message-bubble {
      background: var(--chat-user-bubble);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .csg-message-time {
      font-size: 11px;
      color: var(--chat-text-secondary);
      padding: 0 4px;
    }

    .csg-message.is-user .csg-message-time {
      text-align: right;
    }

    /* Markdown styling in AI messages */
    .csg-message-bubble p {
      margin: 0 0 8px 0;
    }

    .csg-message-bubble p:last-child {
      margin-bottom: 0;
    }

    .csg-message-bubble code {
      background: rgba(0, 0, 0, 0.06);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: var(--code-font-family, monospace);
      font-size: 13px;
    }

    .csg-message-bubble pre {
      background: #1E293B;
      color: #E2E8F0;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
    }

    .csg-message-bubble pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .csg-message-bubble ul,
    .csg-message-bubble ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .csg-message-bubble li {
      margin: 4px 0;
    }

    .csg-message-bubble a {
      color: var(--chat-primary);
      text-decoration: none;
    }

    .csg-message-bubble a:hover {
      text-decoration: underline;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Typing Indicator
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-typing {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
    }

    .csg-typing-dot {
      width: 8px;
      height: 8px;
      background: var(--chat-text-secondary);
      border-radius: 50%;
      animation: csg-typing-bounce 1.4s infinite ease-in-out;
    }

    .csg-typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .csg-typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .csg-typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes csg-typing-bounce {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Thinking Section
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-thinking-section {
      margin-bottom: 12px;
      border: 1px solid var(--chat-border);
      border-left: 3px solid var(--chat-primary);
      border-radius: 8px;
      overflow: hidden;
      background: #F9FAFB;
    }

    .csg-thinking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #F3F4F6;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease;
    }

    .csg-thinking-header:hover {
      background: #E5E7EB;
    }

    .csg-thinking-status {
      font-size: 13px;
      font-weight: 500;
      color: var(--chat-primary);
    }

    .csg-thinking-section.is-thinking .csg-thinking-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .csg-thinking-section.is-thinking .csg-thinking-status::after {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid var(--chat-primary);
      border-top-color: transparent;
      border-radius: 50%;
      animation: csg-thinking-spin 0.8s linear infinite;
    }

    @keyframes csg-thinking-spin {
      to { transform: rotate(360deg); }
    }

    .csg-thinking-toggle {
      font-size: 12px;
      color: var(--chat-text-secondary);
      transition: transform 0.2s ease;
    }

    .csg-thinking-section.is-expanded .csg-thinking-toggle {
      transform: rotate(180deg);
    }

    .csg-thinking-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 12px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--chat-text-secondary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .csg-thinking-section.is-expanded .csg-thinking-content {
      max-height: 400px;
      padding: 8px 12px 12px;
      overflow-y: auto;
    }

    .csg-thinking-content::-webkit-scrollbar {
      width: 4px;
    }

    .csg-thinking-content::-webkit-scrollbar-thumb {
      background: var(--chat-border);
      border-radius: 2px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Input Area
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    .csg-chat-input-area {
      padding: 16px 20px;
      background: var(--chat-surface);
      border-top: 1px solid var(--chat-border);
      flex-shrink: 0;
    }

    .csg-chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .csg-chat-input {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 16px;
      border: 2px solid var(--chat-border);
      border-radius: 14px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.5;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .csg-chat-input:focus {
      border-color: var(--chat-primary);
      box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1);
    }

    .csg-chat-input::placeholder {
      color: var(--chat-text-secondary);
    }

    .csg-chat-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: none;
      background: var(--chat-primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .csg-chat-send-btn:hover:not(:disabled) {
      background: var(--chat-primary-dark);
      transform: scale(1.05);
    }

    .csg-chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .csg-chat-send-btn svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Mobile Styles - Bottom Sheet
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    @media (max-width: 767px) {
      .csg-chat-btn {
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
      }

      .csg-chat-btn svg {
        width: 24px;
        height: 24px;
      }

      .csg-chat-window {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: 85vh;
        max-height: 85vh;
        border-radius: 24px 24px 0 0;
        transform: translateY(100%);
      }

      .csg-chat-window.is-open {
        transform: translateY(0);
      }

      /* Backdrop overlay */
      .csg-chat-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .csg-chat-backdrop.is-visible {
        opacity: 1;
        visibility: visible;
      }

      /* Drag handle */
      .csg-chat-drag-handle {
        display: flex;
        justify-content: center;
        padding: 12px 0 8px;
        background: linear-gradient(135deg, var(--chat-primary) 0%, var(--chat-primary-dark) 100%);
        cursor: grab;
        touch-action: none;
      }

      .csg-chat-drag-handle::before {
        content: '';
        width: 40px;
        height: 4px;
        background: rgba(255, 255, 255, 0.4);
        border-radius: 2px;
      }

      .csg-chat-header {
        padding-top: 8px;
      }
    }

    @media (min-width: 768px) {
      .csg-chat-backdrop,
      .csg-chat-drag-handle {
        display: none;
      }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Reduced Motion
       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    @media (prefers-reduced-motion: reduce) {
      .csg-chat-btn,
      .csg-chat-window,
      .csg-message,
      .csg-typing-dot {
        animation: none;
        transition: none;
      }
    }
  </style>

  <!-- Chatbot HTML Structure -->
  <div class="csg-chat-backdrop" id="csgBackdrop"></div>

  <button class="csg-chat-btn" id="csgChatBtn" aria-label="æ‰“å¼€èŠå¤©åŠ©æ‰‹">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 2.98.97 4.29L2 22l5.71-.97C9.02 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm-1 14h2v2h-2v-2zm0-10h2v8h-2V6z"/>
    </svg>
  </button>

  <div class="csg-chat-window" id="csgChatWindow" role="dialog" aria-label="èŠå¤©åŠ©æ‰‹">
    <!-- Drag handle for mobile -->
    <div class="csg-chat-drag-handle" id="csgDragHandle"></div>

    <!-- Header -->
    <div class="csg-chat-header">
      <div class="csg-chat-header-info">
        <div class="csg-chat-avatar">ğŸ“š</div>
        <div>
          <div class="csg-chat-title">è—ä¹¦é˜åŠ©æ‰‹</div>
          <div class="csg-chat-subtitle">æœ‰é—®å¿…ç­”ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡</div>
        </div>
      </div>
      <div class="csg-chat-actions">
        <button class="csg-chat-action-btn" id="csgClearBtn" title="æ¸…ç©ºå¯¹è¯">
          <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
        </button>
        <button class="csg-chat-action-btn" id="csgCloseBtn" title="å…³é—­">
          <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="csg-chat-messages" id="csgMessages">
      <div class="csg-chat-welcome">
        <div class="csg-chat-welcome-icon">ğŸ“–</div>
        <h3>æ¬¢è¿æ¥åˆ°è—ä¹¦é˜</h3>
        <p>æˆ‘æ˜¯æ‚¨çš„é˜…è¯»åŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨è§£ç­”å…³äºä¹¦ç±å†…å®¹çš„é—®é¢˜ï¼Œæˆ–è€…æ¨èç›¸å…³é˜…è¯»ææ–™ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ</p>
      </div>
    </div>

    <!-- Input -->
    <div class="csg-chat-input-area">
      <div class="csg-chat-input-wrapper">
        <textarea
          class="csg-chat-input"
          id="csgInput"
          placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
          rows="1"
          aria-label="æ¶ˆæ¯è¾“å…¥"
        ></textarea>
        <button class="csg-chat-send-btn" id="csgSendBtn" aria-label="å‘é€æ¶ˆæ¯">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Chatbot JavaScript -->
  <script>
  (function() {
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Configuration
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const BASE_CONFIG = {
      // Cloudflare Worker ä»£ç†åœ°å€
      proxyUrl: 'https://bookstore-chat.james-hobby-tan.workers.dev',
      maxHistoryLength: 50,
      user: 'bookstore-user-' + (localStorage.getItem('csg_user_id') || (() => {
        const id = Math.random().toString(36).substring(7);
        localStorage.setItem('csg_user_id', id);
        return id;
      })())
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // State
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let currentBookPath = null;
    let bookConfig = null;
    let conversationId = '';
    let isStreaming = false;
    let currentStreamMessage = null;
    let thinkingStartTime = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DOM Elements
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const chatBtn = document.getElementById('csgChatBtn');
    const chatWindow = document.getElementById('csgChatWindow');
    const backdrop = document.getElementById('csgBackdrop');
    const closeBtn = document.getElementById('csgCloseBtn');
    const clearBtn = document.getElementById('csgClearBtn');
    const messagesContainer = document.getElementById('csgMessages');
    const input = document.getElementById('csgInput');
    const sendBtn = document.getElementById('csgSendBtn');
    const dragHandle = document.getElementById('csgDragHandle');
    const chatTitle = document.querySelector('.csg-chat-title');
    const chatSubtitle = document.querySelector('.csg-chat-subtitle');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Book Detection & Config Loading
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getBookPathFromHash() {
      const hash = window.location.hash || '';
      // Match patterns like #/books/book-name/ or #/books/book-name/chapter
      const match = hash.match(/^#\/books\/([^\/]+)/);
      return match ? match[1] : null;
    }

    function getStorageKey(bookPath, suffix) {
      return `csg_${bookPath}_${suffix}`;
    }

    async function loadBookConfig(bookPath) {
      try {
        const response = await fetch(`./books/${bookPath}/_chatbot.json`);
        if (!response.ok) return null;
        const config = await response.json();
        return config.enabled ? config : null;
      } catch (e) {
        console.log(`No chatbot config for book: ${bookPath}`);
        return null;
      }
    }

    function updateUIWithConfig(config) {
      if (!config) return;

      // Update header
      if (chatTitle && config.title) {
        chatTitle.textContent = config.title;
      }
      if (chatSubtitle && config.subtitle) {
        chatSubtitle.textContent = config.subtitle;
      }

      // Update welcome message
      const welcomeTitle = config.welcomeTitle || 'æ¬¢è¿';
      const welcomeMessage = config.welcomeMessage || 'æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ';

      messagesContainer.innerHTML = `
        <div class="csg-chat-welcome">
          <div class="csg-chat-welcome-icon">ğŸ“–</div>
          <h3>${escapeHtml(welcomeTitle)}</h3>
          <p>${escapeHtml(welcomeMessage)}</p>
        </div>
      `;
    }

    function showChatbot() {
      chatBtn.style.display = 'flex';
    }

    function hideChatbot() {
      chatBtn.style.display = 'none';
      closeChat();
    }

    async function handleRouteChange() {
      const newBookPath = getBookPathFromHash();

      // If same book, do nothing
      if (newBookPath === currentBookPath) return;

      // Close chat window when changing books
      closeChat();

      // If not on a book page, hide chatbot
      if (!newBookPath) {
        currentBookPath = null;
        bookConfig = null;
        hideChatbot();
        return;
      }

      // Try to load book config
      const config = await loadBookConfig(newBookPath);

      if (!config) {
        currentBookPath = null;
        bookConfig = null;
        hideChatbot();
        return;
      }

      // Book has chatbot enabled
      currentBookPath = newBookPath;
      bookConfig = config;

      // Load conversation ID for this book
      conversationId = localStorage.getItem(getStorageKey(currentBookPath, 'conversation_id')) || '';

      // Update UI
      updateUIWithConfig(config);
      restoreHistory();
      showChatbot();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Utilities
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function formatTime(date) {
      return new Intl.DateTimeFormat('zh-CN', {
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderMarkdown(text) {
      if (typeof marked !== 'undefined') {
        marked.setOptions({
          breaks: true,
          gfm: true
        });
        return marked.parse(text);
      }
      return escapeHtml(text).replace(/\n/g, '<br>');
    }

    // Parse thinking content from response
    function parseThinkingContent(rawContent) {
      if (!rawContent || !rawContent.includes('<think>')) {
        return {
          hasThinking: false,
          thinking: '',
          displayContent: rawContent || '',
          isThinkingComplete: false
        };
      }

      const thinkMatch = rawContent.match(/<think>([\s\S]*?)(<\/think>|$)/);
      if (!thinkMatch) {
        return {
          hasThinking: false,
          thinking: '',
          displayContent: rawContent,
          isThinkingComplete: false
        };
      }

      const thinking = thinkMatch[1];
      const isThinkingComplete = rawContent.includes('</think>');
      const displayContent = rawContent.replace(/<think>[\s\S]*?<\/think>/, '').trim();

      return {
        hasThinking: true,
        thinking,
        displayContent,
        isThinkingComplete
      };
    }

    function getThinkingDuration() {
      if (!thinkingStartTime) return 0;
      return ((Date.now() - thinkingStartTime) / 1000).toFixed(1);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Storage (Per-Book)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function loadHistory() {
      if (!currentBookPath) return [];
      try {
        const history = localStorage.getItem(getStorageKey(currentBookPath, 'history'));
        return history ? JSON.parse(history) : [];
      } catch (e) {
        console.error('Failed to load chat history:', e);
        return [];
      }
    }

    function saveHistory(messages) {
      if (!currentBookPath) return;
      try {
        const trimmed = messages.slice(-BASE_CONFIG.maxHistoryLength);
        localStorage.setItem(getStorageKey(currentBookPath, 'history'), JSON.stringify(trimmed));
      } catch (e) {
        console.error('Failed to save chat history:', e);
      }
    }

    function clearHistory() {
      if (!currentBookPath) return;
      localStorage.removeItem(getStorageKey(currentBookPath, 'history'));
      localStorage.removeItem(getStorageKey(currentBookPath, 'conversation_id'));
      conversationId = '';
      updateUIWithConfig(bookConfig);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Message Rendering
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function createMessageElement(role, content, time, thinking = null, thinkingDuration = null) {
      const isUser = role === 'user';
      const messageEl = document.createElement('div');
      messageEl.className = `csg-message ${isUser ? 'is-user' : 'is-ai'}`;

      let bubbleContent = '';
      if (isUser) {
        bubbleContent = escapeHtml(content);
      } else {
        // Handle thinking content for historical messages
        if (thinking) {
          bubbleContent += createThinkingSection(thinking, true, thinkingDuration);
        }
        // Content is already cleaned (no <think> tags) when stored in history
        bubbleContent += renderMarkdown(content);
      }

      messageEl.innerHTML = `
        <div class="csg-message-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ“š'}</div>
        <div class="csg-message-content">
          <div class="csg-message-bubble">${bubbleContent}</div>
          <span class="csg-message-time">${time || formatTime(new Date())}</span>
        </div>
      `;

      return messageEl;
    }

    function createTypingIndicator() {
      const el = document.createElement('div');
      el.className = 'csg-message is-ai';
      el.id = 'csgTyping';
      el.innerHTML = `
        <div class="csg-message-avatar">ğŸ“š</div>
        <div class="csg-message-content">
          <div class="csg-message-bubble">
            <div class="csg-typing">
              <span class="csg-typing-dot"></span>
              <span class="csg-typing-dot"></span>
              <span class="csg-typing-dot"></span>
            </div>
          </div>
        </div>
      `;
      return el;
    }

    function createThinkingSection(thinking, isComplete, duration) {
      const statusText = isComplete
        ? `ğŸ’­ å·²æ·±åº¦æ€è€ƒ (${duration || '?'}s)`
        : 'ğŸ’­ æ€è€ƒä¸­...';
      const thinkingClass = isComplete ? '' : 'is-thinking';

      return `
        <div class="csg-thinking-section ${thinkingClass}">
          <div class="csg-thinking-header">
            <span class="csg-thinking-status">${statusText}</span>
            <span class="csg-thinking-toggle">â–¼</span>
          </div>
          <div class="csg-thinking-content">${escapeHtml(thinking)}</div>
        </div>
      `;
    }

    function updateMessageBubble(messageEl, rawContent, parsed) {
      const bubble = messageEl.querySelector('.csg-message-bubble');
      if (!bubble) return;

      let html = '';

      if (parsed.hasThinking) {
        const duration = parsed.isThinkingComplete ? getThinkingDuration() : null;
        html += createThinkingSection(parsed.thinking, parsed.isThinkingComplete, duration);
      }

      if (parsed.displayContent) {
        html += renderMarkdown(parsed.displayContent);
      }

      bubble.innerHTML = html;
    }

    function addMessage(role, content, save = true) {
      // Remove welcome message if present
      const welcome = messagesContainer.querySelector('.csg-chat-welcome');
      if (welcome) welcome.remove();

      const messageEl = createMessageElement(role, content);
      messagesContainer.appendChild(messageEl);
      scrollToBottom();

      if (save) {
        const history = loadHistory();
        history.push({
          role,
          content,
          time: formatTime(new Date()),
          timestamp: Date.now()
        });
        saveHistory(history);
      }

      return messageEl;
    }

    function updateStreamingMessage(content) {
      const parsed = parseThinkingContent(content);

      // Start thinking timer when first <think> is detected
      if (parsed.hasThinking && !thinkingStartTime) {
        thinkingStartTime = Date.now();
      }

      if (!currentStreamMessage) {
        const welcome = messagesContainer.querySelector('.csg-chat-welcome');
        if (welcome) welcome.remove();

        currentStreamMessage = createMessageElement('assistant', '');
        messagesContainer.appendChild(currentStreamMessage);
      }

      updateMessageBubble(currentStreamMessage, content, parsed);
      scrollToBottom();
    }

    function finalizeStreamingMessage(content) {
      if (currentStreamMessage) {
        const parsed = parseThinkingContent(content);
        const duration = thinkingStartTime ? getThinkingDuration() : null;

        // Update final display with correct duration
        if (parsed.hasThinking && duration) {
          updateMessageBubble(currentStreamMessage, content, {
            ...parsed,
            isThinkingComplete: true
          });
          // Update the duration text
          const statusEl = currentStreamMessage.querySelector('.csg-thinking-status');
          if (statusEl) {
            statusEl.textContent = `ğŸ’­ å·²æ·±åº¦æ€è€ƒ (${duration}s)`;
          }
          // Remove spinning animation
          const section = currentStreamMessage.querySelector('.csg-thinking-section');
          if (section) {
            section.classList.remove('is-thinking');
          }
        }

        const history = loadHistory();
        history.push({
          role: 'assistant',
          content: parsed.displayContent || content,  // Store cleaned content without <think> tags
          thinking: parsed.thinking || null,
          thinkingDuration: duration,
          time: formatTime(new Date()),
          timestamp: Date.now()
        });
        saveHistory(history);
      }
      currentStreamMessage = null;
      thinkingStartTime = null;
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function restoreHistory() {
      const history = loadHistory();
      if (history.length === 0) return;

      // Remove welcome message
      const welcome = messagesContainer.querySelector('.csg-chat-welcome');
      if (welcome) welcome.remove();

      history.forEach(msg => {
        const el = createMessageElement(msg.role, msg.content, msg.time, msg.thinking, msg.thinkingDuration);
        messagesContainer.appendChild(el);
      });

      scrollToBottom();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API Integration
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function sendMessage(userMessage) {
      if (isStreaming || !userMessage.trim() || !bookConfig) return;

      isStreaming = true;
      sendBtn.disabled = true;
      input.disabled = true;

      // Add user message
      addMessage('user', userMessage);

      // Show typing indicator
      const typingEl = createTypingIndicator();
      messagesContainer.appendChild(typingEl);
      scrollToBottom();

      let fullResponse = '';

      try {
        // é€šè¿‡ Cloudflare Worker ä»£ç†è°ƒç”¨ Dify API
        const response = await fetch(BASE_CONFIG.proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            bookId: currentBookPath,
            bookTitle: bookConfig?.bookTitle || bookConfig?.title || currentBookPath,
            query: userMessage,
            conversationId: conversationId,
            user: BASE_CONFIG.user
          })
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        // Remove typing indicator
        typingEl.remove();

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;

              try {
                const parsed = JSON.parse(data);

                // Handle conversation_id
                if (parsed.conversation_id && !conversationId) {
                  conversationId = parsed.conversation_id;
                  localStorage.setItem(getStorageKey(currentBookPath, 'conversation_id'), conversationId);
                }

                // Handle message content
                if (parsed.event === 'message' && parsed.answer) {
                  fullResponse += parsed.answer;
                  updateStreamingMessage(fullResponse);
                } else if (parsed.event === 'agent_message' && parsed.answer) {
                  fullResponse += parsed.answer;
                  updateStreamingMessage(fullResponse);
                }
              } catch (e) {
                // Ignore JSON parse errors for incomplete chunks
              }
            }
          }
        }

        // Finalize the message
        if (fullResponse) {
          finalizeStreamingMessage(fullResponse);
        }

      } catch (error) {
        console.error('Chat error:', error);
        typingEl.remove();
        addMessage('assistant', 'æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚', false);
      } finally {
        isStreaming = false;
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI Event Handlers
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openChat() {
      chatWindow.classList.add('is-open');
      backdrop.classList.add('is-visible');
      chatBtn.classList.add('is-open');
      chatBtn.classList.remove('has-unread');
      input.focus();
      scrollToBottom();
    }

    function closeChat() {
      chatWindow.classList.remove('is-open');
      backdrop.classList.remove('is-visible');
      chatBtn.classList.remove('is-open');
    }

    function toggleChat() {
      if (chatWindow.classList.contains('is-open')) {
        closeChat();
      } else {
        openChat();
      }
    }

    function handleSend() {
      const message = input.value.trim();
      if (message && !isStreaming) {
        input.value = '';
        input.style.height = 'auto';
        sendMessage(message);
      }
    }

    // Auto-resize textarea
    function autoResize() {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    // Mobile swipe-to-dismiss
    let touchStartY = 0;
    let touchCurrentY = 0;

    function handleTouchStart(e) {
      touchStartY = e.touches[0].clientY;
      touchCurrentY = touchStartY;
    }

    function handleTouchMove(e) {
      touchCurrentY = e.touches[0].clientY;
      const diff = touchCurrentY - touchStartY;

      if (diff > 0) {
        chatWindow.style.transform = `translateY(${diff}px)`;
      }
    }

    function handleTouchEnd() {
      const diff = touchCurrentY - touchStartY;
      chatWindow.style.transform = '';

      if (diff > 100) {
        closeChat();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Initialize
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function init() {
      // Hide chatbot by default
      hideChatbot();

      // Event listeners
      chatBtn.addEventListener('click', toggleChat);
      closeBtn.addEventListener('click', closeChat);
      backdrop.addEventListener('click', closeChat);
      clearBtn.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå¯¹è¯å†å²å—ï¼Ÿ')) {
          clearHistory();
        }
      });

      // Thinking section toggle (event delegation)
      messagesContainer.addEventListener('click', (e) => {
        const header = e.target.closest('.csg-thinking-header');
        if (header) {
          header.parentElement.classList.toggle('is-expanded');
        }
      });

      sendBtn.addEventListener('click', handleSend);

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });

      input.addEventListener('input', autoResize);

      // Mobile touch events for drag handle
      if (dragHandle) {
        dragHandle.addEventListener('touchstart', handleTouchStart, { passive: true });
        dragHandle.addEventListener('touchmove', handleTouchMove, { passive: true });
        dragHandle.addEventListener('touchend', handleTouchEnd, { passive: true });
      }

      // Keyboard shortcut (Escape to close)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && chatWindow.classList.contains('is-open')) {
          closeChat();
        }
      });

      // Listen for route changes (Docsify uses hashchange)
      window.addEventListener('hashchange', handleRouteChange);

      // Initial route check
      handleRouteChange();
    }

    // Wait for DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>
</body>
</html>
